---
import { Moon, Sun } from "@lucide/astro";
---

<button
  class="theme-toggle-btn px-4 py-2 rounded-full text-sm h-8 w-fit flex items-center justify-center cursor-pointer border-2 transition-all duration-300 bg-white border-green-500 text-black hover:bg-green-600"
  aria-label="Toggle theme"
>
  <span class="theme-icon">
    <Sun class="dark:hidden" />
    <Moon class="hidden dark:block" />
  </span>
</button>

<script>
  // Initialize theme from localStorage or default to light mode (only once)
  if (typeof window !== "undefined" && !(window as any).themeInitialized) {
    const isDarkMode = localStorage.getItem("theme") === "dark";

    // Apply initial theme
    if (isDarkMode) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }

    (window as any).themeInitialized = true;
  }

  // Use event delegation to handle clicks on all theme toggle buttons
  // This ensures all instances work, even if they're added dynamically
  if (
    typeof window !== "undefined" &&
    !(window as any).themeToggleHandlerAttached
  ) {
    document.addEventListener("click", (event) => {
      const target = event.target as HTMLElement;
      // Check if click is on the button or inside it
      const button = target.closest(".theme-toggle-btn");

      if (button) {
        const isDarkMode = document.documentElement.classList.contains("dark");

        if (isDarkMode) {
          document.documentElement.classList.remove("dark");
          localStorage.setItem("theme", "light");
        } else {
          document.documentElement.classList.add("dark");
          localStorage.setItem("theme", "dark");
        }
      }
    });

    (window as any).themeToggleHandlerAttached = true;
  }
</script>
