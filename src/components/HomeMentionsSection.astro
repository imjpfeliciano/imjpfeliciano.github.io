---
interface OGMeta {
  title?: string;
  description?: string;
  image?: string;
  url?: string;
  [key: string]: string | undefined;
}

interface Mention {
  url: string;
  title?: string;
  description?: string;
  ogMeta?: OGMeta | null;
}

// Helper function to resolve relative URLs to absolute URLs
function resolveUrl(baseUrl: string, relativeUrl: string): string {
  try {
    return new URL(relativeUrl, baseUrl).href;
  } catch {
    return relativeUrl;
  }
}

// Helper function to fetch and parse OG meta tags from a URL
async function fetchOGMeta(url: string) {
  try {
    const response = await fetch(url, {
      headers: {
        "User-Agent":
          "Mozilla/5.0 (compatible; AstroBot/1.0; +https://astro.build/bot)",
      },
      // Add timeout to prevent hanging
      signal: AbortSignal.timeout(10000), // 10 second timeout
    });

    if (!response.ok) {
      return null;
    }

    const html = await response.text();

    // Extract OG meta tags using regex
    const ogTags: Record<string, string> = {};

    // Match og:property="content" or property="og:..." content="..."
    const ogPattern =
      /<meta\s+(?:property=["']og:([^"']+)["']|name=["']og:([^"']+)["'])\s+content=["']([^"']+)["']/gi;
    let match;

    while ((match = ogPattern.exec(html)) !== null) {
      const property = match[1] || match[2];
      const content = match[3];
      if (property && content) {
        ogTags[property] = content;
      }
    }

    // Also check for twitter:image as fallback
    const twitterImagePattern =
      /<meta\s+name=["']twitter:image["']\s+content=["']([^"']+)["']/i;
    const twitterMatch = html.match(twitterImagePattern);
    if (twitterMatch && !ogTags.image) {
      ogTags.image = twitterMatch[1];
    }

    // Fallback to standard meta tags
    if (!ogTags.title) {
      const titleMatch = html.match(/<title>([^<]+)<\/title>/i);
      if (titleMatch) {
        ogTags.title = titleMatch[1];
      }
    }

    if (!ogTags.description) {
      const descPattern =
        /<meta\s+name=["']description["']\s+content=["']([^"']+)["']/i;
      const descMatch = html.match(descPattern);
      if (descMatch) {
        ogTags.description = descMatch[1];
      }
    }

    // Resolve relative image URLs to absolute URLs
    if (ogTags.image && !ogTags.image.startsWith("http")) {
      ogTags.image = resolveUrl(url, ogTags.image);
    }

    return Object.keys(ogTags).length > 0 ? ogTags : null;
  } catch (error) {
    // Silently fail - don't log errors in production builds
    if (import.meta.env.DEV) {
      console.warn(`Could not fetch OG meta for ${url}:`, error);
    }
    return null;
  }
}

// Mentions data - URLs of posts/articles
// Add optional `title` and `description` fields
// If provided, they will be used instead of OG meta
const mentionsData: Omit<Mention, "ogMeta">[] = [
  // Example: Add your mention URLs here
  // {
  //   url: "https://example.com/article-about-me",
  //   title: "Optional custom title",
  //   description: "Optional custom description",
  // },
  {
    title: "Mentorship at Mexican Olympiad in Informatics - Quintana Roo",
    url: "https://sipse.com/novedades/estudiantes-cancunenses-ganan-bronce-en-olimpiada-nacional-150554.html",
    description: "Students from Cancun, Mexico won bronze in the Mexican Olympiad in Informatics - Quintana Roo.",
  },
  {
    title: "Tips and strategies to succeed in coding interviews",
    url: "https://www.facebook.com/slothtech/photos/a.919234838286849/1316081475268848/",
    description: "Presentation on slothtech's community page about tips and strategies to succeed in coding interviews.",
  }
];

// Fetch OG meta for mentions that have URLs
const mentions = await Promise.all(
  mentionsData.map(async (mention) => {
    let ogMeta = null;
    if (mention.url) {
      ogMeta = await fetchOGMeta(mention.url);
    }
    return {
      ...mention,
      ogMeta,
    };
  })
);

// Only render if there are mentions
const hasMentions = mentions.length > 0;
---

<style>
  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
  
  @keyframes shimmer {
    0% {
      background-position: -1000px 0;
    }
    100% {
      background-position: 1000px 0;
    }
  }
  
  .skeleton {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  .skeleton-shimmer {
    background: linear-gradient(
      90deg,
      rgba(229, 231, 235, 0) 0%,
      rgba(229, 231, 235, 0.8) 50%,
      rgba(229, 231, 235, 0) 100%
    );
    background-size: 1000px 100%;
    animation: shimmer 2s infinite;
  }
  
  .dark .skeleton-shimmer {
    background: linear-gradient(
      90deg,
      rgba(51, 65, 85, 0) 0%,
      rgba(51, 65, 85, 0.8) 50%,
      rgba(51, 65, 85, 0) 100%
    );
    background-size: 1000px 100%;
  }
  
  .image-loading {
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
  }
  
  .image-loaded {
    opacity: 1;
  }
</style>

{hasMentions && (
  <div class="flex flex-col gap-8 w-full max-w-5xl mx-auto py-16">
    <!-- Header Section -->
    <div
      class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
    >
      <div class="flex flex-col gap-2">
        <h2
          class="text-3xl font-bold dark:text-white"
          data-translate="home.mentions.title"
        >
          Mentions & Contributions
        </h2>
        <p
          class="text-gray-600 dark:text-gray-400 text-lg"
          data-translate="home.mentions.description"
        >
          Posts and articles featuring my contributions and work.
        </p>
      </div>
    </div>

    <!-- Mentions Cards Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {
        mentions.map((mention) => {
          // Show skeleton when ogMeta is null (fetching or failed)
          const isLoading = mention.ogMeta === null;
          
          return isLoading ? (
            // Full Skeleton Card
            <div class="border border-gray-300 dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-slate-800 shadow-md flex flex-col">
              {/* Image Skeleton */}
              <div class="w-full aspect-video bg-gray-200 dark:bg-gray-700 skeleton skeleton-shimmer" />
              
              {/* Content Skeleton */}
              <div class="flex flex-col gap-3 p-6">
                <div class="flex flex-col gap-1">
                  {/* Title Skeleton */}
                  <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded skeleton skeleton-shimmer w-3/4" />
                  {/* Description Skeleton */}
                  <div class="flex flex-col gap-2 mt-2">
                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded skeleton skeleton-shimmer w-full" />
                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded skeleton skeleton-shimmer w-5/6" />
                  </div>
                </div>
                {/* URL Skeleton */}
                <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded skeleton skeleton-shimmer w-1/3" />
              </div>
            </div>
          ) : (
            // Actual Card
            <a
              href={mention.url}
              target="_blank"
              rel="noopener noreferrer"
              class="border border-gray-300 dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-slate-800 shadow-md hover:shadow-lg transition-shadow duration-200 group flex flex-col"
            >
              {/* OG Image - only show if image exists */}
              {mention.ogMeta?.image && (
                <div class="w-full aspect-video overflow-hidden bg-gray-100 dark:bg-gray-700 relative">
                  <img
                    src={mention.ogMeta.image}
                    alt={mention.title || mention.ogMeta.title || "Article"}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200 image-loading"
                    loading="lazy"
                    onload="this.classList.remove('image-loading'); this.classList.add('image-loaded'); this.nextElementSibling?.remove();"
                  />
                  <div class="skeleton skeleton-shimmer absolute inset-0 bg-gray-200 dark:bg-gray-700" />
                </div>
              )}

              <div class="flex flex-col gap-3 p-6">
                <div class="flex flex-col gap-1">
                  {mention.title || mention.ogMeta?.title ? (
                    <h3 class="text-xl font-bold dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                      {mention.title || mention.ogMeta?.title}
                    </h3>
                  ) : (
                    <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded skeleton skeleton-shimmer w-3/4" />
                  )}
                  {/* Description - prioritize provided description over OG meta */}
                  {mention.description || mention.ogMeta?.description ? (
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2 line-clamp-2">
                      {mention.description || mention.ogMeta?.description}
                    </p>
                  ) : (
                    <div class="flex flex-col gap-2 mt-2">
                      <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded skeleton skeleton-shimmer w-full" />
                      <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded skeleton skeleton-shimmer w-5/6" />
                    </div>
                  )}
                </div>
                {/* URL domain */}
                {mention.url && (
                  <div class="text-xs text-gray-400 dark:text-gray-500 truncate">
                    {new URL(mention.url).hostname.replace("www.", "")}
                  </div>
                )}
              </div>
            </a>
          );
        })
      }
    </div>
  </div>
)}
